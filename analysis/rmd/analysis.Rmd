---
title: "R & python"
description: |
  ä½¿ç”¨ python è®­ç»ƒæ¨¡å‹, ä½¿ç”¨ R åˆ›å»ºåº”ç”¨.
author:
  - name: Jixing Liu
    url: https://jixing.netlify.com/
    affiliation: DeepDrug
    affiliation_url: http://www.deepdrug.cn/en/
date: "`r Sys.Date()`"
#bibliography: biblio.bib  
output:
  radix::radix_article:
    css: Blog_Template_Style.css
    toc: true
    toc_depth: 3
    number_sections: true
    self_contained: true
  md_document:
always_allow_html: yes
#bibliography: ./../../references.bib
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,      # Output code chunks
    message = TRUE,  # Toggle off message output 
    warning = TRUE,    # Toggle off warning output
    fig.width = 6, fig.asp = 0.618, out.width = "70%", fig.align = "center") 

knitr::opts_knit$set(root.dir = usethis::proj_path())
library(docknitr)

# libraries used in report
library(knitr)
library(kableExtra)
library(tidyverse)

theme_set(theme_light(base_family = "Avenir"))
```


## install and setup

```{r}
library(reticulate)
reticulate::use_python("/Users/zero/anaconda3/envs/reticulate/bin/python3",
                       required = TRUE)

reticulate::py_config()

#reticulate::repl_python()

#virtualenv_install("debunk", packages = c("pandas", "scikit-learn"))
#pandas <- import("pandas")

```

## create model

å­˜æˆ `drake/01-create_model.py`è„šæœ¬æ–‡ä»¶

```{python}
# load module
from sklearn.datasets import load_breast_cancer
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import MinMaxScaler
from sklearn.svm import SVC

from joblib import dump
from pyprojroot import here

# load data
cancer = load_breast_cancer()
X_train, X_test, y_train, y_test = train_test_split(
    cancer.data, cancer.target, random_state=42)
scaler = MinMaxScaler().fit(X_train)
X_train_scaled = scaler.transform(X_train)
X_test_scaled = scaler.transform(X_test)

# learn an SVM on the scaled training data
svm = SVC()
svm.fit(X_train_scaled, y_train)

# save model
dump(svm, here("analysis/data/derived_data/python_model.joblib", warn=False))
dump(X_test_scaled, here("analysis/data/derived_data/test_data.joblib", warn=False))

```

## load model and use 

å­˜æˆ `drake/02-load_model.py`è„šæœ¬æ–‡ä»¶

```{python}
from joblib import load
from pyprojroot import here

python_model = load(here("analysis/data/derived_data/python_model.joblib"))
test_data = load(here("analysis/data/derived_data/test_data.joblib"))

```

```{r}
py$test_data
```


å¯ä»¥ä½¿ç”¨ R æ¥åŠ è½½ python çš„æ¨¡å‹å—? å½“ç„¶å¯ä»¥
```{r}
reticulate::source_python("drake/02-load_model.py")
```


## predict

è¿™é‡Œè¦æ³¨æ„å¦‚æœæ˜¯ä¸€ä¸ªç—…äºº, R ä¼šè‡ªåŠ¨è½¬å˜ä¸ºå‘é‡, æ‰€ä»¥è¦ä½¿ç”¨`t()`è¿›è¡Œè½¬ç§©.

```{r}
# test_data çš„è¡Œæ˜¯ç—…äºº, åˆ—æ˜¯å˜é‡(feature)
py$test_data[1,] %>%
    t() %>%
  py$python_model$predict()
```

å¯¹äºå¤šä¸ªç—…äººåˆ™ä¸éœ€è¦è¿›è¡Œæ ¼å¼è½¬æ¢

```{r}
test_data[1:6,] %>% py$python_model$predict()
```

##  ğŸ³  åŸå‹æ„å»ºå’Œæµ‹è¯•

åœ¨è¿™é‡Œæ„å»º shiny çš„æ¨¡å—åŸå‹

### å…ˆè®¾ç½®å’Œshiny APPä¸€æ ·çš„ç¯å¢ƒ

è¿™ä¸ªä¸€èˆ¬æ˜¯ `run_app` å‡½æ•°çš„å‰åŠéƒ¨åˆ†, ä»¥åŠä¸€äº› `ui` çš„å˜é‡è®¾ç½®, ä½œä¸º `server`çš„è¾“å…¥.

```{r}
library(shiny)
library(ggplot2)
library(reticulate)

reticulate::use_python("/Users/zero/anaconda3/envs/reticulate/bin/python3",
                       required = TRUE)
knitr::knit_engines$set(python = reticulate::eng_python)

reticulate::py_config()

if (fs::file_exists("analysis/data/derived_data/python_model.joblib")) {
  print("Python model already exists, no need to re-run python script.")
} else {
  print("Python model does not exist, running python model creation script")
  reticulate::source_python("drake/01-create_model.py")
}

rm(list = ls())
reticulate::source_python("drake/02-load_model.py")

```

### æ„å»ºé¢„æµ‹æ¨¡å—

```{r}
predict_y <- py$python_model$predict(test_data)
```

### ç”»å›¾

```{r}
predict_y %>% 
  enframe() %>% 
  ggplot(aes(value)) +
  geom_bar()
```

### ä¸Šä¼ æ–‡ä»¶, å¹¶é¢„æµ‹

```{r}
reticulate::source_python("drake/02-load_model.py")
rio::export(test_data, "analysis/data/raw_data/test_data.csv")
```


```{r}
reticulate::source_python("drake/02-load_model.py")
# load
df <- rio::import("analysis/data/raw_data/test_data.csv")
# predict
py$python_model$predict(df)
```












